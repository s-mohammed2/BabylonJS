<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>2D Racing Game</title>
        <script src="babylon.js"></script>
<!--        <script src="http://www.babylonjs.com/babylon.js"></script>-->
        <script type="text/javascript" src="trackConstruction.js"></script>  
<!--        <script type="text/javascript" src="trackGenerator.js"></script>-->
        <style>
            html, body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }
            #time {
                position: absolute;
                left: 30px;
                top: 30px;
                font-size: 3em;
                color: white;
                font-family: "Segoe UI";
            }
            #time_div{
                position: absolute;
                left: 550px;
                top: 30px;
                font-size: 3em;
                color: white;
                font-family: "Segoe UI";
            }
            #start{
                position: absolute;
                text-align: center;
                font-size: 2em;
                color: white;
                font-family: "Segoe UI";
                width: 100%;
                height: 100%;
                background-color: blue;
            }
            #name{
                height: 26px;
                font-family: Segoe UI;
                width: 200px;
            }
            input#startButton{
                cursor:pointer; 
                padding:5px 25px; 
                background:#35b128;
                border:1px solid #33842a; 
                -moz-border-radius: 10px;
                -webkit-border-radius: 10px;
                border-radius: 10px;
                -webkit-box-shadow: 0 0 4px rgba(0,0,0, .75);
                -moz-box-shadow: 0 0 4px rgba(0,0,0, .75);
                box-shadow: 0 0 4px rgba(0,0,0, .75);
                color:#f3f3f3;
                font-size:0.6em;
            }
            input#startButton:hover, input#startButton:focus{
                 background-color :#399630; 
                -webkit-box-shadow: 0 0 1px rgba(0,0,0, .75);
                -moz-box-shadow: 0 0 1px rgba(0,0,0, .75);
                box-shadow: 0 0 1px rgba(0,0,0, .75);
            }
        </style>
    </head>
<body>
     <div id="start">
        <p>2D Racing Game. Your competition is against the racers who have already played the game or playing the game now. 
        To win the game try to complete the race in shortest possible time. 
        In the end of the game you will see your time against all other racers.</p>
        <input type="button" value="Next" id="startButton" onclick="load_image()">
    </div>
    
<!--    <div>
        <p>A mini map of the track located on the right side can be used to navigate from start to Finish.</p>
        <div id="imageBody" style="top:5px;">
            <img src="screenshot.jpg" height="400" width="800"></div>
            <input type="button" value="Start" id="startButton">
    </div>-->
    <canvas id="renderCanvas"></canvas>
    <div id="time" style="display: none;">Time: 0</div>
    <div id="time_div"></div>   
    <script type="text/javascript">   
        var canvas = document.getElementById("renderCanvas");
        var engine = new BABYLON.Engine(canvas, true);
        var scene = new BABYLON.Scene(engine);

        var camera = new BABYLON.FreeCamera("camera1",  new BABYLON.Vector3(20, 2, -10), scene);
        //BABYLON.Viewport = function (x, y, width, height); (20, 2, -20)
        camera.viewport = new BABYLON.Viewport(0, 0, 1, 1);
        camera.layerMask = 2; // 010 in binary
        //camera.attachControl(canvas, true);
        
        var camera2 = new BABYLON.FreeCamera("camera2",  new BABYLON.Vector3(24, 14, -37), scene);
        //var camera2 = new BABYLON.FreeCamera("camera2",  new BABYLON.Vector3(24, 14, -47), scene);
        camera2.viewport = new BABYLON.Viewport(0.8, 0.8, 0.2, 0.2);
        //camera2.viewport = new BABYLON.Viewport(1, 1, 0.15, 0.22);
//        camera2.viewport = new BABYLON.Viewport(0.2, 0.1, 0.90, 0.90);
        camera2.layerMask = 1;
        
        scene.activeCameras.push(camera);
        scene.activeCameras.push(camera2);
       
        var light = new BABYLON.HemisphericLight("light1",new BABYLON.Vector3(0, 15, -15), scene);
        //light.intensity = .5;
        
        var skybox = BABYLON.Mesh.CreateBox("skyBox", 800.0, scene);
        var skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
        skyboxMaterial.backFaceCulling = false;
        skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("textures/skybox", scene);
        skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
        skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
        skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
        skybox.material = skyboxMaterial;
       
        
        var tracks = [];
        var size = 1;
        var carScale = 0.5;       
        var startTime = new Date();
        var scenes = -1;
        var elapsedTime = 0;
        var decision = "";
       
        //loadingScreen(1);
        trackGeneration();
        for(var i=0;i<trackheight;i++){
            for(var j=0;j<trackwidth;j++){                
                if(track[i][j] === 6){
                    var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                    lane.scaling.y = size;
                    lane.scaling.x = size;
                    lane.scaling.z = 0.01;
                    lane.position.x = j*size;
                    lane.position.y = i*size;
                    lane.renderingGroupId = 1;
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_texture409.jpg", scene);
                    lane.material = laneMaterial;
                    var car = BABYLON.Mesh.CreateBox("base", 1, scene);
                    car.scaling.y = carScale;
                    car.scaling.x = carScale;
                    car.scaling.z = 0.1;
                    var material = new BABYLON.StandardMaterial("Material", scene);
                    material.diffuseTexture = new BABYLON.Texture("Car_thumb1.png", scene);
                    car.material = material;
                    car.renderingGroupId = 1;
                    car.position = new BABYLON.Vector3(j*size, i*size, 0);
                    camera.position = new BABYLON.Vector3(j*size, i*size, -10);

                    var s = BABYLON.Mesh.CreateSphere("player2", 16, 4, scene);
                    var red = new BABYLON.StandardMaterial("red", this.scene);
                    red.diffuseColor = BABYLON.Color3.Red();
                    red.specularColor = BABYLON.Color3.Black();
                    s.material = red;
                    s.renderingGroupId = 1;
                    s.layerMask = 1;
                    s.registerBeforeRender(function() {
                        s.position.x = car.position.x;
                        s.position.y = car.position.y;
                    });
                    
                }
                else if(track[i][j] === 0){   //tileable_grass_00.png
                    var grass = BABYLON.Mesh.CreateBox("box", 0, scene);
                    grass.scaling.x = size;
                    grass.scaling.y = size;
                    grass.scaling.z = 0.01; //grass is bigger than road
                    grass.renderingGroupId = 1;
                    grass.position = new BABYLON.Vector3(j*size, i*size, 0);
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("tileable_grass.png", scene);
                    grass.material = laneMaterial;
                }
                else if(track[i][j] === 2){
                    var x = j*size;
                    var y = i*size;
                    var half = size/2;
                    //Inside Triangle
                    var triangle = drawTriangle(scene, "test1", x-half, y-half, x+half, y+half, x+half, y-half);
                    var material = new BABYLON.StandardMaterial("texturelane", scene);
                    material.diffuseTexture = new BABYLON.Texture("asphalt_text.jpg", scene);
                    triangle.material = material;
                    triangle.material.backFaceCulling = false;
                    var triangle2 = drawTriangle(scene, "test1", x-half, y-half, x+half, y+half, x-half, y+half);
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("tileable_grass.png", scene);
                    triangle2.material = laneMaterial;
                    triangle2.material.backFaceCulling = false;
                }
                else if(track[i][j] === 3){
                    var x = j*size;
                    var y = i*size;
                    var half = size/2;
                    //Inside Triangle
                    var triangle = drawTriangle(scene, "test1", x-half, y-half, x+half, y+half, x+half, y-half);
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("tileable_grass.png", scene);
                    triangle.material = laneMaterial;
                    triangle.material.backFaceCulling = false;
                    var triangle2 = drawTriangle(scene, "test1", x-half, y-half, x+half, y+half, x-half, y+half);
                    var material = new BABYLON.StandardMaterial("texturelane", scene);
                    material.diffuseTexture = new BABYLON.Texture("asphalt_text.jpg", scene);
                    triangle2.material = material;
                    triangle2.material.backFaceCulling = false;
                }
                else if(track[i][j] === 4){
                    var x = j*size;
                    var y = i*size;
                    var half = size/2;
                    //outside Triangle
                    var triangle = drawTriangle(scene, "test1", x+half, y-half, x-half, y+half, x+half, y+half);
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("tileable_grass.png", scene);
                    triangle.material = laneMaterial;
                    triangle.material.backFaceCulling = false;
                    var triangle2 = drawTriangle(scene, "test1", x+half, y-half, x-half, y+half, x-half, y-half);
                    var material = new BABYLON.StandardMaterial("texturelane", scene);
                    material.diffuseTexture = new BABYLON.Texture("asphalt_text.jpg", scene);
                    triangle2.material = material;
                    triangle2.material.backFaceCulling = false;
                }
                else if(track[i][j] === 5){
                    var x = j*size;
                    var y = i*size;
                    var half = size/2;
                    //Inside Triangle
                    var triangle = drawTriangle(scene, "test1", x+half, y-half, x-half, y+half, x+half, y+half);
                    var material = new BABYLON.StandardMaterial("texturelane", scene);
                    material.diffuseTexture = new BABYLON.Texture("road-texture4.png", scene);
                    material.diffuseTexture = new BABYLON.Texture("asphalt_text.jpg", scene);
                    triangle.material = material;
                    triangle.material.backFaceCulling = false;
                    var triangle2 = drawTriangle(scene, "test1", x+half, y-half, x-half, y+half, x-half, y-half);
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("tileable_grass.png", scene);
                    triangle2.material = laneMaterial;
                    triangle2.material.backFaceCulling = false;
                }
                else if(track[i][j] === -1 || track[i][j] === 77 || track[i][j] === 70){
                    var x = j*size;
                    var y = i*size;
                    var half = size/2;
                    //Inside Triangle
                    var triangle = drawTriangle(scene, "test1", x-half, y-half, x+half, y+half, x+half, y-half);
                    var material = new BABYLON.StandardMaterial("texturelane", scene);
                    material.diffuseTexture = new BABYLON.Texture("asphalt_text.jpg", scene);
                    triangle.material = material;
                    triangle.material.backFaceCulling = false;
                    var triangle2 = drawTriangle(scene, "test1", x-half, y-half, x+half, y+half, x-half, y+half);
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_text.jpg", scene);
                    triangle2.material = laneMaterial;
                    triangle2.material.backFaceCulling = false;
                    
                }
                else if(track[i][j] === -2 || track[i][j] === 49 || track[i][j] === 55){
                    var x = j*size;
                    var y = i*size;
                    var half = size/2;
                    //Inside Triangle
                    var triangle = drawTriangle(scene, "test1", x+half, y-half, x-half, y+half, x+half, y+half);
                    var material = new BABYLON.StandardMaterial("texturelane", scene);
                    material.diffuseTexture = new BABYLON.Texture("road-texture4.png", scene);
                    material.diffuseTexture = new BABYLON.Texture("asphalt_text.jpg", scene);
                    triangle.material = material;
                    triangle.material.backFaceCulling = false;
                    var triangle2 = drawTriangle(scene, "test1", x+half, y-half, x-half, y+half, x-half, y-half);
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_text.jpg", scene);
                    triangle2.material = laneMaterial;
                    triangle2.material.backFaceCulling = false;
                    
                }
                else if(track[i][j] === 11 || track[i][j] === 79 || track[i][j] === 78 || track[i][j] === 50 || track[i][j] === 52){
                    var x = j*size;
                    var y = i*size;
                    var half = size/2;
                    //Inside Triangle
                    var triangle = drawTriangle(scene, "test1", x+half, y-half, x-half, y+half, x+half, y+half);
                    var material = new BABYLON.StandardMaterial("texturelane", scene);
                    material.diffuseTexture = new BABYLON.Texture("asphalt_text.jpg", scene);
                    triangle.material = material;
                    triangle.material.backFaceCulling = false;
                    var triangle2 = drawTriangle(scene, "test1", x+half, y-half, x-half, y+half, x-half, y-half);
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_text.jpg", scene);
                    triangle2.material = laneMaterial;
                    triangle2.material.backFaceCulling = false;
                }
                else if(track[i][j] === 22){
                   var x = j*size;
                    var y = i*size;
                    var half = size/2;
                    //Inside Triangle
                    var triangle = drawTriangle(scene, "test1", x-half, y-half, x+half, y+half, x+half, y-half);
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_text.jpg", scene);
                    triangle.material = laneMaterial;
                    triangle.material.backFaceCulling = false;
                    var triangle2 = drawTriangle(scene, "test1", x-half, y-half, x+half, y+half, x-half, y+half);
                    var material = new BABYLON.StandardMaterial("texturelane", scene);
                    material.diffuseTexture = new BABYLON.Texture("asphalt_text.jpg", scene);
                    triangle2.material  = material;
                    triangle2.material.backFaceCulling = false;
                }
                else if(track[i][j] === -3){
                    var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                    lane.scaling.y = size;
                    lane.scaling.x = size;
                    lane.scaling.z = 0.01;
                    lane.position.x = j*size;
                    lane.position.y = i*size;
                    lane.renderingGroupId = 1;
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_text.jpg", scene);
                    lane.material = laneMaterial;
                }
                else if(track[i][j] === -4){
                    var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                    lane.scaling.y = size;
                    lane.scaling.x = size;
                    lane.scaling.z = 0.01;
                    lane.position.x = j*size;
                    lane.position.y = i*size;
                    lane.renderingGroupId = 1;
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("noyonrt.jpg", scene);
                    lane.material = laneMaterial;
                }
                else if(track[i][j] === -5){
                    var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                    lane.scaling.y = size;
                    lane.scaling.x = size;
                    lane.scaling.z = 0.01;
                    lane.position.x = j*size;
                    lane.position.y = i*size;
                    lane.renderingGroupId = 1;
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("noyonlt.jpg", scene);
                    lane.material = laneMaterial;
                }
                else if(track[i][j] === -6){
                    var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                    lane.scaling.y = size;
                    lane.scaling.x = size;
                    lane.scaling.z = 0.01;
                    lane.position.x = j*size;
                    lane.position.y = i*size;
                    lane.renderingGroupId = 1;
                    
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("ybelow.jpg", scene);
                    lane.material = laneMaterial;
                }
                else if(track[i][j] === -7){
                    var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                    lane.scaling.y = size;
                    lane.scaling.x = size;
                    lane.scaling.z = 0.01;
                    lane.position.x = j*size;
                    lane.position.y = i*size;
                    lane.renderingGroupId = 1;
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("norightbelow.jpg", scene);
                    lane.material = laneMaterial;
                }
                else if(track[i][j] === -8){
                    var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                    lane.scaling.y = size;
                    lane.scaling.x = size;
                    lane.scaling.z = 0.01;
                    lane.position.x = j*size;
                    lane.position.y = i*size;
                    lane.renderingGroupId = 1;
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("yontop.jpg", scene);
                    lane.material = laneMaterial;
                }
                else if(track[i][j] === -9){
                    var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                    lane.scaling.y = size;
                    lane.scaling.x = size;
                    lane.scaling.z = 0.01;
                    lane.position.x = j*size;
                    lane.position.y = i*size;
                    lane.renderingGroupId = 1;
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("yontopnoleft.jpg", scene);
                    lane.material = laneMaterial;
                }
                else if(track[i][j] === 10){
                    var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                    lane.scaling.y = size;
                    lane.scaling.x = size;
                    lane.scaling.z = 0.01;
                    lane.position.x = j*size;
                    lane.position.y = i*size;
                    lane.renderingGroupId = 1;
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("yontopnoright.jpg", scene);
                    lane.material = laneMaterial;
                }
                else if(track[i][j] === 33){
                    var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                    lane.scaling.y = size;
                    lane.scaling.x = size;
                    lane.scaling.z = 0.01;
                    lane.position.x = j*size;
                    lane.position.y = i*size;
                    lane.renderingGroupId = 1;
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("custom_side_no_left.jpg", scene);
                    lane.material = laneMaterial;
                }
                else if(track[i][j] === 44){
                    var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                    lane.scaling.y = size;
                    lane.scaling.x = size;
                    lane.scaling.z = 0.01;
                    lane.position.x = j*size;
                    lane.position.y = i*size;
                    lane.renderingGroupId = 1;
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("custom_side_no_right.jpg", scene);
                    lane.material = laneMaterial;
                }
                else if(track[i][j] === 39){
                    var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                    lane.scaling.y = size;
                    lane.scaling.x = size;
                    lane.scaling.z = 0.01;
                    lane.position.x = j*size;
                    lane.position.y = i*size;
                    lane.renderingGroupId = 1;
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_sideStar.jpg", scene);
                    lane.material = laneMaterial;
                }
                else if(track[i][j] === 35){
                    var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                    lane.scaling.y = size;
                    lane.scaling.x = size;
                    lane.scaling.z = 0.01;
                    lane.position.x = j*size;
                    lane.position.y = i*size;
                    lane.renderingGroupId = 1;
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_star.jpg", scene);
                    lane.material = laneMaterial;
                }
                else if(track[i][j] === 8){
                    var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                    lane.scaling.y = size;
                    lane.scaling.x = size;
                    lane.scaling.z = 0.01;
                    lane.position.x = j*size;
                    lane.position.y = i*size;
                    lane.renderingGroupId = 1;
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("maxresdefault.jpg", scene);
                    lane.material = laneMaterial;
                }
                else{// if(track[i][j] === 1){
                    var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                    lane.scaling.y = size;
                    lane.scaling.x = size;
                    lane.scaling.z = 0.01;
                    lane.position.x = j*size;
                    lane.position.y = i*size;
                    lane.renderingGroupId = 1;
                    var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                    laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_texture409.jpg", scene);
                    lane.material = laneMaterial;
                }
            }
        }
        
    function loadingScreen(command){
        if(command)
            engine.displayLoadingUI();
        else
            engine.hideLoadingUI();
    }

    var startCount = new Date();
    var person = "";
    var lastFrame = 0;
    var frameDiff = 0;
    
    engine.runRenderLoop(function () {
        if(scenes === 0){
            loadingScreen(0);
            while(person === "" || person === null)
                person = prompt("Please enter your name", " ");
            startCount = new Date();
            scenes = 1;
            scene.render();
        }
        else if(scenes !== -1){
            var temp = new Date();
            var timer  = temp - startCount;
            timer = Math.floor(timer/1000);
            if(timer <= 4){
                if(timer !== 0){
                    timer = 4 - timer;
                    if(timer === 0){
                        document.getElementById('time_div').innerHTML = "GO!!";
                    }
                    else
                        document.getElementById('time_div').innerHTML = timer;
                }
            }
            else if(scenes !== 2 && scenes !== 3){
                activateControls();
                document.getElementById('time_div').style.display = "none";
                document.getElementById('time').style.display = "block";
                controls = 0;
                startTime = new Date();
                lastFrame = new Date();
                scenes = 2;
            }
            //scene.render();
        }
        if(scenes === 2){
            checkInput();
            move();
            if(gameEnd()){
                scenes = 3;
                /*alert("Time for race completion "+elapsedTime);
                alert("Thanks for playing the game  "+decision);
                if(decision.length === 29){
                    alert("Perfect -->"+decision.length);
                }
                else{
                    alert("Error occured -->"+decision.length);
                }*/
                var result_div = document.getElementById('time_div');
                result_div.style.innerHTML = "";
                result_div.style.display = "block";
                result_div.style.left = "285px";
                result_div.style.top = "125px";
                result_div.innerHTML = "Thank You for playing 2D WEBGL GAME. Redirecting Please wait..";
                var dataToSend = elapsedTime+","+person+":"+tracks.toString()+":"+decision;
                var address = document.location.href;
//                if(address.indexOf("localhost"))
//                    window.location.href = "http://wiu.edu/users/sm101/test.php?data="+dataToSend;
//                else if(addres.indexOf("wiu.edu"))
//                    window.location.href = "http://wiu.edu/users/sm101/test.php?data="+dataToSend;
//                else
                    window.location.href = "http://wiu.edu/users/sm101/scoreboard.php?data="+dataToSend;
            }
            else{
                var currentTime = new Date();
                frameDiff = currentTime - lastFrame;
                scale = frameDiff/1000;
                lastFrame = currentTime;
                elapsedTime = currentTime - startTime;
                elapsedTime = Math.floor(elapsedTime/1000);
                document.getElementById("time").innerHTML = "Time: " + elapsedTime + " Seconds";
            }
            scene.render();
        }
    });
    
        // Resize
    window.addEventListener("resize", function () {
        engine.resize();
    });
    
   
    
    function drawTriangle(scene, name, x1, y1, x2, y2, x3, y3) { 
        //Let's create a mesh for our element:
        var triangle = new BABYLON.Mesh(name, scene);
        //Then, the points for the triangle element:
        var positions = [
          x1, y1, 0,
          x2, y2, 0,
          x3, y3, 0
        ];
        //Next, we create the normals (orientation):
        var normals = [
          1, 1, 1,
          1, 1, 1,
          1, 1, 1
        ];
        
        var normals = [
          1, 1, 0,
          1, 1, 0,
          1, 1, 0
        ];
        
        //if uv is not present textures will not work.
        var uv = [0, 0,
                  1, 0,
                  1, 1];
        //And the indices, for the points order:
        var indices = [];
        indices.push(0);
        indices.push(1);
        indices.push(2);
        //Finally, we load everything in our mesh:
        triangle.setVerticesData(BABYLON.VertexBuffer.PositionKind, positions, true);
        triangle.setVerticesData(BABYLON.VertexBuffer.NormalKind, normals, true);
        triangle.setVerticesData(BABYLON.VertexBuffer.UVKind, uv, true);
        triangle.setIndices(indices);
        return triangle;
    }
        
    
        var keys = [];
        var keysUp = [38];
        var keysDown = [40];
        var keysLeft = [37];
        var keysRight = [39];
        var speed = 6;
        var scale = 1;
        var collision = false;
        var directionx = new BABYLON.Vector3(0, 0, 0);
        var directiony = new BABYLON.Vector3(0, 0, 0);


        var checkInput = function () {
            for (var index = 0; index < keys.length; index++) {
                var keyCode = keys[index];
                if (keysLeft.indexOf(keyCode) !== -1) {
                    directionx.addInPlace(new BABYLON.Vector3(-speed * scale, 0, 0));
                } else if (keysUp.indexOf(keyCode) !== -1) {
                    directiony.addInPlace(new BABYLON.Vector3(0, speed * scale, 0));
                } else if (keysRight.indexOf(keyCode) !== -1) {
                    directionx.addInPlace(new BABYLON.Vector3(speed * scale, 0, 0));
                } else if (keysDown.indexOf(keyCode) !== -1) {
                    directiony.addInPlace(new BABYLON.Vector3(0, -speed * scale, 0));
                }
            }
        };
    
    var move = function(){
         car.position.addInPlace(directionx);
         camera.position.addInPlace(directionx);
         if(checkCollisions()){
            ////console.log("Collision detected !!");
            car.position.addInPlace(new BABYLON.Vector3(-directionx.x,0,0));
            camera.position.addInPlace(new BABYLON.Vector3(-directionx.x,0,0));
         }
         car.position.addInPlace(directiony);
         camera.position.addInPlace(directiony);
         camera2.position.addInPlace(directiony);
         if(checkCollisions()){
            ////console.log("Collision detected !!");
            car.position.addInPlace(new BABYLON.Vector3(0,-directiony.y,0));
            camera.position.addInPlace(new BABYLON.Vector3(0,-directiony.y,0));
            camera2.position.addInPlace(new BABYLON.Vector3(0,-directiony.y,0));
         }
        directionx = new BABYLON.Vector3(0, 0, 0);
        directiony = new BABYLON.Vector3(0, 0, 0);
    };
    
    function gameEnd(){
        var xindex = car.position.x+size/2;
        xindex = Math.floor(xindex/size);    
        
        var yindex = car.position.y+size/2;
        yindex = Math.floor(yindex/size);
  
        if(track[yindex][xindex] === 7){
            if(decision === "")
                decision = decision+"ls";
            else
                decision = decision+",ls";
            track[yindex][xindex] = 1;
            if(track[yindex][xindex+1] !== 0)
                track[yindex][xindex+1] = 1;
            if(track[yindex][xindex-1] !== 0)
                track[yindex][xindex-1] = 1;
        }
        else if(track[yindex][xindex] === 77 || track[yindex][xindex] === 79){
            if(decision === "")
                decision = decision+"ls";
            else
                decision = decision+",ls";
            track[yindex][xindex] = 1;
        }
        else if(track[yindex][xindex] === 9){
            if(decision === "")
                decision = decision+"st";
            else
                decision = decision+",st";
            track[yindex][xindex] = 1;
            if(track[yindex][xindex+1] !== 0)
                track[yindex][xindex+1] = 1;
            if(track[yindex][xindex-1] !== 0)
                track[yindex][xindex-1] = 1;
        }
        else if(track[yindex][xindex] === 90){
            if(decision === "")
                decision = decision+"ss";
            else
                decision = decision+",ss";
            track[yindex][xindex] = 1;
            if(track[yindex][xindex+1] !== 0)
                track[yindex][xindex+1] = 1;
            if(track[yindex][xindex-1] !== 0)
                track[yindex][xindex-1] = 1;
        }
        else if(track[yindex][xindex] === 88){
            if(decision === "")
                decision = decision+"lt";
            else
                decision = decision+",lt";
            track[yindex][xindex] = 1;
            if(track[yindex][xindex+1] !== 0)
                track[yindex][xindex+1] = 1;
            if(track[yindex][xindex-1] !== 0)
                track[yindex][xindex-1] = 1;
        }
        else if(track[yindex][xindex] === 78 || track[yindex][xindex] === 70){
            if(decision === "")
                decision = decision+"lt";
            else
                decision = decision+",lt";
            track[yindex][xindex] = 1;
        }
        else if(track[yindex][xindex] === 8){
            track[yindex][xindex] = 1;
            return true;
        }
        else
            return false;
    }        
    
    var checkCollisions = function(){
            var xindex = car.position.x+size/2;
            xindex = Math.floor(xindex/size);
            
            var yindex = car.position.y+size/2;
            yindex = Math.floor(yindex/size);
            
            var rightside = (car.position.x+(carScale/2))+size/2;
            var actualRightSide = rightside/size;
            rightside = Math.floor(rightside/size);
            
            var leftside = (car.position.x-(carScale/2))+size/2;
            var actualLeftSide = leftside/size;
            leftside = Math.floor(leftside/size);
            
            var upside = (car.position.y+(carScale/2))+size/2;
            var actualUpSide = upside/size;
            upside = Math.floor(upside/size);
            
            var downside = (car.position.y-(carScale/2))+size/2;
            var actualDownside = downside/size;
            downside = Math.floor(downside/size);            
            
            if(downside < 0)
                return true;

            if(track[upside][leftside] === 2){
                if((actualUpSide-upside)>=(actualLeftSide-leftside)){
                    return true;
                }
            }
            else if(track[upside][rightside] === 2 ){
                if((actualUpSide-upside)>=(actualRightSide-rightside)){
                    return true;
                }
            }
            
            if(track[downside][rightside] === 3){
                if((actualDownside-downside)<= (actualRightSide-rightside)){
                    return true;
                }
            }
            else if(track[downside][leftside] === 3){
                if((actualDownside-downside)<=(actualLeftSide-leftside)){
                    return true;
                }
            }
            
            if(track[downside][leftside] === 5){
                var yparameter = actualDownside-downside;
                var xparamater = actualLeftSide-leftside;
                xparamater = size-xparamater;
                if(yparameter<=xparamater){
                    return true;
                }
            }
            else if(track[upside][leftside] === 5){
                var yparameter = actualUpSide-upside;
                var xparamater = actualLeftSide-leftside;
                xparamater = size-xparamater;
                if(yparameter<=xparamater){
                    return true;
                }
            }
            
            
            
            if(track[upside][rightside] === 4){
                var yparameter = actualUpSide-upside;
                var xparamater = actualRightSide-rightside;
                xparamater = size-xparamater;
                if(yparameter>=xparamater){
                    return true;
                }
            }
            else if(track[downside][rightside] === 4){
                var yparameter = actualDownside-downside;
                var xparamater = actualRightSide-rightside;
                xparamater = size-xparamater;
                if(yparameter>=xparamater){
                    return true;
                }
            }
            
            
            if(track[yindex][xindex] === 55 ){
                track[yindex][xindex] = 1;
                var trackSegment = yindex/height;
                trackSegment = Math.ceil(trackSegment);
                if(trackSegment !== 1){
                    trackSegment = (trackSegment-1)*32;
                    trackSegment = trackSegment+27;
                }
                else
                    trackSegment = 27;
                var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                lane.scaling.y = size;
                lane.scaling.x = size;
                lane.scaling.z = 0.01;
                lane.position.x = 31*size;
                lane.position.y = (trackSegment-1)*size;
                lane.renderingGroupId = 1;
                var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_side_donoenter.jpg", scene);
                lane.material = laneMaterial;
                track[trackSegment-1][31] = 0;
                var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                lane.scaling.y = size;
                lane.scaling.x = size;
                lane.scaling.z = 0.01;
                lane.position.x = 31*size;
                lane.position.y = trackSegment*size;
                lane.renderingGroupId = 1;
                var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_side_donoenter.jpg", scene);
                lane.material = laneMaterial;
                track[trackSegment][31] = 0;
            }
            
            if(track[yindex][xindex] === 54){
                track[yindex][xindex] = 1;
                var trackSegment = yindex/height;
                trackSegment = Math.ceil(trackSegment);
                if(trackSegment !== 1){
                    trackSegment = (trackSegment-1)*32;
                    trackSegment = trackSegment+25;
                }
                else
                    trackSegment = 25;
                var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                lane.scaling.y = size;
                lane.scaling.x = size;
                lane.scaling.z = 0.01;
                lane.position.x = 36*size;
                lane.position.y = trackSegment*size;
                lane.renderingGroupId = 1;
                var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_side_donoenter.jpg", scene);
                lane.material = laneMaterial;
                track[trackSegment][36] = 0;
            }
            
            if(track[yindex][xindex] === 53){
                track[yindex][xindex] = 1;
                var trackSegment = yindex/height;
                if(track[yindex][xindex+1] !== 0)
                    track[yindex][xindex+1] = 1;
                if(track[yindex][xindex-1] !== 0)
                    track[yindex][xindex-1] = 1;
                trackSegment = Math.ceil(trackSegment);
                if(trackSegment !== 1){
                    trackSegment = (trackSegment-1)*32;
                    trackSegment = trackSegment+25;
                }
                else
                    trackSegment = 25;
                var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                lane.scaling.y = size;
                lane.scaling.x = size;
                lane.scaling.z = 0.01;
                lane.position.x = 30*size;
                lane.position.y = (trackSegment+2)*size;
                lane.renderingGroupId = 1;
                var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_side_donoenter.jpg", scene);
                lane.material = laneMaterial;
                track[trackSegment+2][30] = 0;
                var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                lane.scaling.y = size;
                lane.scaling.x = size;
                lane.scaling.z = 0.01;
                lane.position.x = 30*size;
                lane.position.y = (trackSegment+1)*size;
                lane.renderingGroupId = 1;
                var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_side_donoenter.jpg", scene);
                lane.material = laneMaterial;
                track[trackSegment+1][30] = 0;
            }
            
            if(track[yindex][xindex] === 52){
                track[yindex][xindex] = 1;
                var trackSegment = yindex/height;
                trackSegment = Math.ceil(trackSegment);
                if(trackSegment !== 1){
                    trackSegment = (trackSegment-1)*32;
                    trackSegment = trackSegment+25;
                }
                else
                    trackSegment = 25;
                var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                lane.scaling.y = size;
                lane.scaling.x = size;
                lane.scaling.z = 0.01;
                lane.position.x = 33*size;
                lane.position.y = trackSegment*size;
                lane.renderingGroupId = 1;
                var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_donotenter.jpg", scene);
                lane.material = laneMaterial;
                track[trackSegment][33] = 0;
                var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                lane.scaling.y = size;
                lane.scaling.x = size;
                lane.scaling.z = 0.01;
                lane.position.x = 34*size;
                lane.position.y = trackSegment*size;
                lane.renderingGroupId = 1;
                var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_donotenter.jpg", scene);
                lane.material = laneMaterial;
                track[trackSegment][34] = 0;
            }
            
            if(track[yindex][xindex] === 51){
                track[yindex][xindex] = 1;
                var trackSegment = yindex/height;
                trackSegment = Math.ceil(trackSegment);
                if(trackSegment !== 1){
                    trackSegment = (trackSegment-1)*32;
                    trackSegment = trackSegment+25;
                }
                else
                    trackSegment = 25;
                var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                lane.scaling.y = size;
                lane.scaling.x = size;
                lane.scaling.z = 0.01;
                lane.position.x = 12*size;
                lane.position.y = trackSegment*size;
                lane.renderingGroupId = 1;
                var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_side_donoenter.jpg", scene);
                lane.material = laneMaterial;
                track[trackSegment][12] = 0;
            }
            
            if(track[yindex][xindex] === 50){
                track[yindex][xindex] = 1;
                var trackSegment = yindex/height;
                trackSegment = Math.ceil(trackSegment);
                if(trackSegment !== 1){
                    trackSegment = (trackSegment-1)*32;
                    trackSegment = trackSegment+25;
                }
                else
                    trackSegment = 25;
                var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                lane.scaling.y = size;
                lane.scaling.x = size;
                lane.scaling.z = 0.01;
                lane.position.x = 17*size;
                lane.position.y = (trackSegment+1)*size;
                lane.renderingGroupId = 1;
                var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_side_donoenter.jpg", scene);
                lane.material = laneMaterial;
                track[trackSegment+1][17] = 0;
                var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                lane.scaling.y = size;
                lane.scaling.x = size;
                lane.scaling.z = 0.01;
                lane.position.x = 17*size;
                lane.position.y = (trackSegment+2)*size;
                lane.renderingGroupId = 1;
                var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_side_donoenter.jpg", scene);
                lane.material = laneMaterial;
                track[trackSegment+2][17] = 0;
            }
            
            if(track[yindex][xindex] === 49 ){
                track[yindex][xindex] = 1;
                var trackSegment = yindex/height;
                trackSegment = Math.ceil(trackSegment);
                if(trackSegment !== 1){
                    trackSegment = (trackSegment-1)*32;
                    trackSegment = trackSegment+25;
                }
                else
                    trackSegment = 25;
                var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                lane.scaling.y = size;
                lane.scaling.x = size;
                lane.scaling.z = 0.01;
                lane.position.x = 14*size;
                lane.position.y = trackSegment*size;
                lane.renderingGroupId = 1;
                var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_donotenter.jpg", scene);
                lane.material = laneMaterial;
                track[trackSegment][14] = 0;
                var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                lane.scaling.y = size;
                lane.scaling.x = size;
                lane.scaling.z = 0.01;
                lane.position.x = 15*size;
                lane.position.y = trackSegment*size;
                lane.renderingGroupId = 1;
                var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_donotenter.jpg", scene);
                lane.material = laneMaterial;
                track[trackSegment][15] = 0;
            }
            
            if(track[yindex][xindex] === 48){
                track[yindex][xindex] = 1;
                var trackSegment = yindex/height;
                if(track[yindex][xindex+1] !== 0)
                    track[yindex][xindex+1] = 1;
                if(track[yindex][xindex-1] !== 0)
                    track[yindex][xindex-1] = 1;
                trackSegment = Math.ceil(trackSegment);
                if(trackSegment !== 1){
                    trackSegment = (trackSegment-1)*32;
                    trackSegment = trackSegment+25;
                }
                else
                    trackSegment = 25;
                var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                lane.scaling.y = size;
                lane.scaling.x = size;
                lane.scaling.z = 0.01;
                lane.position.x = 18*size;
                lane.position.y = (trackSegment+2)*size;
                lane.renderingGroupId = 1;
                var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_side_donoenter.jpg", scene);
                lane.material = laneMaterial;
                track[trackSegment+2][18] = 0;
                var lane = BABYLON.Mesh.CreateBox("lane"+(i+j), 1, scene);
                lane.scaling.y = size;
                lane.scaling.x = size;
                lane.scaling.z = 0.01;
                lane.position.x = 18*size;
                lane.position.y = (trackSegment+1)*size;
                lane.renderingGroupId = 1;
                var laneMaterial = new BABYLON.StandardMaterial("texturelane", scene);
                laneMaterial.diffuseTexture = new BABYLON.Texture("asphalt_side_donoenter.jpg", scene);
                lane.material = laneMaterial;
                track[trackSegment+1][18] = 0;
            }

            if(track[upside][leftside] === 0){
                return true;
            }
            else if(track[upside][rightside] === 0 ){
                return true;
            }
            else if(track[downside][leftside] === 0){
                return true;
            }
            else if(track[downside][rightside] === 0){
                return true;
            }
            else if(leftside < 0 || downside < 0){
                return true;
            }
            else{
                return false;
            }          
            
    };
    
        var onKeyDown = function (evt) {
            if (keysUp.indexOf(evt.keyCode) !== -1 ||
                keysDown.indexOf(evt.keyCode) !== -1 ||
                keysLeft.indexOf(evt.keyCode) !== -1 ||
                keysRight.indexOf(evt.keyCode) !== -1) {
                var index = keys.indexOf(evt.keyCode);
                if (index === -1) {
                    keys.push(evt.keyCode);
                }
                evt.preventDefault();
            }
        };

        var onKeyUp = function (evt) {
            if (keysUp.indexOf(evt.keyCode) !== -1 ||
                keysDown.indexOf(evt.keyCode) !== -1 ||
                keysLeft.indexOf(evt.keyCode) !== -1 ||
                keysRight.indexOf(evt.keyCode) !== -1) {
                var index = keys.indexOf(evt.keyCode);
                if (index >= 0) {
                    keys.splice(index, 1);
                }
                evt.preventDefault();
            }
        };
        
        function activateControls(){
            window.addEventListener("keydown", onKeyDown, false);
            window.addEventListener("keyup", onKeyUp, false);
        }
        
        
        function so_cleardiv(myDiv){
            while (myDiv.firstChild) {
                myDiv.removeChild(myDiv.firstChild);
            }
        }
        
        function load_image(){
            var content = document.getElementById('start');
            so_cleardiv(content);
            var element = document.createElement('p');
            var newtext = document.createTextNode("A mini map of the track located on the right side can be used to navigate from start to finish."); 
            element.appendChild(newtext);
            content.appendChild(element);
            var innerDiv = document.createElement('div');
            innerDiv.setAttribute("id", "imageBody");
            innerDiv.style.top = "5px";
            var imgTag = document.createElement('img');
            imgTag.setAttribute("src", "screenshot.jpg");
            imgTag.setAttribute("height", "400");
            imgTag.setAttribute("width", "800");
            innerDiv.appendChild(imgTag);
            content.appendChild(innerDiv);
            var button = document.createElement('input');
            button.setAttribute("type", "button");
            button.setAttribute("value", "Start");
            button.setAttribute("onclick", "start_game()");
            button.setAttribute("id", "startButton");
            content.appendChild(button);
        }
        
        function start_game(){
            document.getElementById('start').style.display = "none";
            loadingScreen(1);
            scenes = 0;
        }
        
        

    </script>
</body>
</html>
